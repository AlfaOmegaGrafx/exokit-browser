<!doctype html>
<html>
  <head>
    <style>
body {
  margin: 0;
}
    </style>
    <script src="three.js"></script>
    <script src="OrbitControls.js"></script>
    <script type=module>
import {Vector3, Quaternion, GameObject} from './vrarmik/Unity.js';
import PoseManager from './vrarmik/PoseManager.js';
import ShoulderTransforms from './vrarmik/ShoulderTransforms.js';

// VRArmIK

const root = new GameObject('root');
const rig = new GameObject('rig');
root.AddChild(rig);
const poseManager = rig.AddComponent(PoseManager);
const shoulderTransforms = rig.AddComponent(ShoulderTransforms);
window.shoulderTransforms = shoulderTransforms;

GameObject.startAll();

// THREE

const scene = new THREE.Scene();

const camera = new THREE.PerspectiveCamera(90, window.innerWidth / window.innerHeight, 0.1, 1000);
camera.position.y = 1;
camera.position.z = 0.5;
// camera.rotation.y = Math.PI;

const ambientLight = new THREE.AmbientLight(0x808080);
scene.add(ambientLight);

const directionalLight = new THREE.DirectionalLight(0xFFFFFF, 1);
directionalLight.position.set(0.5, 1, 0.5);
scene.add(directionalLight);

/* const directionalLight2 = new THREE.DirectionalLight(0xFFFFFF, 1);
directionalLight2.position.set(0, -0.25, -0.25);
scene.add(directionalLight2); */

const cubeGeometry = new THREE.ConeBufferGeometry(0.05, 0.2, 3)
  .applyMatrix(new THREE.Matrix4().makeRotationFromQuaternion(
    new THREE.Quaternion().setFromUnitVectors(new THREE.Vector3(0, 1, 0), new THREE.Vector3(0, 0, 1)))
  );
const materials ={};
const _getCubeMaterial = color => {
  let material = materials[color];
  if (!material) {
    material = new THREE.MeshPhongMaterial({
      color,
      flatShading: true,
    });
    materials[color] = material;
  }
  return material;
}
const _makeCubeMesh = (color = 0x0000FF) => {
  const mesh = new THREE.Mesh(cubeGeometry, _getCubeMaterial(color));
  mesh.frustumCulled = false;
  return mesh;
};
const meshes = {
  hmd: _makeCubeMesh(0xFF0000),
  upperChest: _makeCubeMesh(0xFFFF00),
  shoulderLeft: _makeCubeMesh(0x00FF00),
  shoulderRight: _makeCubeMesh(0x008000),
  upperArmLeft: _makeCubeMesh(0x00FFFF),
  upperArmRight: _makeCubeMesh(0x008080),
  lowerArmLeft: _makeCubeMesh(0x0000FF),
  lowerArmRight: _makeCubeMesh(0x000080),
  handLeft: _makeCubeMesh(0xFFFFFF),
  handRight: _makeCubeMesh(0x808080),
};
for (const k in meshes) {
  scene.add(meshes[k]);
}
/* scene.remove(meshes.shoulderLeft);
scene.remove(meshes.upperArmLeft);
scene.remove(meshes.lowerArmLeft);
scene.remove(meshes.handLeft);
scene.remove(meshes.shoulderRight);
scene.remove(meshes.upperArmRight);
scene.remove(meshes.lowerArmRight);
scene.remove(meshes.handRight); */

const renderer = new THREE.WebGLRenderer({
  // canvas: document.getElementById('canvas'),
  // alpha: true,
  antialias: true,
});
// console.log('set size', window.innerWidth, window.innerHeight);
renderer.setSize(window.innerWidth, window.innerHeight);
renderer.setPixelRatio(window.devicePixelRatio);
renderer.sortObjects = false;
document.body.appendChild(renderer.domElement);

const orbitControls = new THREE.OrbitControls(camera, renderer.domElement);
orbitControls.screenSpacePanning = true;
orbitControls.enableMiddleZoom = false;
orbitControls.update();

const poses = {
  hmd: new THREE.Object3D(),
  leftGamepad: new THREE.Object3D(),
  rightGamepad: new THREE.Object3D(),
};
poses.hmd.position.y = 0.5;
poses.leftGamepad.position.set(-0.3, 0, 0.3);
poses.rightGamepad.position.set(0.5, -0.5, 0.3);
for (const k in poses) {
  scene.add(poses[k]);
}

function animate() {
  poses.hmd.quaternion.setFromAxisAngle(new THREE.Vector3(0, 1, 0), Math.sin((Date.now()%2000)/2000*Math.PI)*Math.PI*0.2);
  poses.leftGamepad.position.x = -0.5 + Math.sin((Date.now()%2000)/2000*Math.PI) * 0.3;
  poses.rightGamepad.position.y = Math.sin((Date.now()%2000)/2000*Math.PI) * 0.3;
  poses.rightGamepad.position.z = Math.sin((Date.now()%2000)/2000*Math.PI) * 0.3;

  poseManager.vrTransforms.hmd.position = poses.hmd.position;
  poseManager.vrTransforms.hmd.rotation = poses.hmd.quaternion;
  poseManager.vrTransforms.leftController.position = poses.leftGamepad.position;
  poseManager.vrTransforms.leftController.rotation = poses.leftGamepad.quaternion;
  poseManager.vrTransforms.rightController.position = poses.rightGamepad.position;
  poseManager.vrTransforms.rightController.rotation = poses.rightGamepad.quaternion;

  poseManager.vrTransforms.head.position = poses.hmd.position;
  poseManager.vrTransforms.head.rotation = poses.hmd.quaternion;
  poseManager.vrTransforms.leftHand.position = poses.leftGamepad.position;
  poseManager.vrTransforms.leftHand.rotation = poses.leftGamepad.quaternion;
  poseManager.vrTransforms.rightHand.position = poses.rightGamepad.position;
  poseManager.vrTransforms.rightHand.rotation = poses.rightGamepad.quaternion;

  GameObject.updateAll();

  // console.log('load rot', shoulderTransforms.leftArm.upperArm.rotation.toArray().join(','));
  /* if (!shoulderTransforms.leftArm.upperArm.rotation.equals(new Quaternion())) {
    debugger;
  } */

  meshes.hmd.position.copy(poseManager.vrTransforms.hmd.position);
  meshes.hmd.quaternion.copy(poseManager.vrTransforms.hmd.rotation);

  meshes.upperChest.position.copy(shoulderTransforms.transform.position);
  meshes.upperChest.quaternion.copy(shoulderTransforms.transform.rotation);

  meshes.shoulderLeft.position.copy(shoulderTransforms.leftShoulderAnchor.position);
  meshes.shoulderLeft.quaternion.copy(shoulderTransforms.leftShoulderAnchor.rotation);
  meshes.upperArmLeft.position.copy(shoulderTransforms.leftArm.upperArm.position);
  meshes.upperArmLeft.quaternion.copy(shoulderTransforms.leftArm.upperArm.rotation);
  meshes.lowerArmLeft.position.copy(shoulderTransforms.leftArm.lowerArm.position);
  meshes.lowerArmLeft.quaternion.copy(shoulderTransforms.leftArm.lowerArm.rotation);
  meshes.handLeft.position.copy(shoulderTransforms.leftArm.hand.position);
  meshes.handLeft.quaternion.copy(shoulderTransforms.leftArm.hand.rotation);

  meshes.shoulderRight.position.copy(shoulderTransforms.rightShoulderAnchor.position);
  meshes.shoulderRight.quaternion.copy(shoulderTransforms.rightShoulderAnchor.rotation);
  meshes.upperArmRight.position.copy(shoulderTransforms.rightArm.upperArm.position);
  meshes.upperArmRight.quaternion.copy(shoulderTransforms.rightArm.upperArm.rotation);
  meshes.lowerArmRight.position.copy(shoulderTransforms.rightArm.lowerArm.position);
  meshes.lowerArmRight.quaternion.copy(shoulderTransforms.rightArm.lowerArm.rotation);
  meshes.handRight.position.copy(shoulderTransforms.rightArm.hand.position);
  meshes.handRight.quaternion.copy(shoulderTransforms.rightArm.hand.rotation);

  renderer.render(scene, camera);
}
renderer.setAnimationLoop(animate);
    </script>
  </body>
</html>
