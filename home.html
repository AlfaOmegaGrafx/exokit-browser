<!doctype html>
<html>
  <head>
    <link href="https://fonts.googleapis.com/css?family=Open+Sans:300,400,600,700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Lato:300,400,600,700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Montserrat:300,400,600,700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Raleway:300,400,600,700&display=swap" rel="stylesheet">
    <style>
* {
  box-sizing: border-box;
}
body {
  width: 100vw;
  height: 100vh;
  margin: 0;
  font-size: 12px;
  overflow: hidden;
}
.hero {
  position: absolute;
  display: flex;
  top: 0;
  left: 0;
  width: 50%;
  height: 100%;
  // justify-content: center;
  align-items: center;
}
.hero .wrap {
  width: 410px;
  margin: 100px;
  font-family: 'Open Sans';
}
.hero .wrap h1 {
  font-family: 'Raleway';
  font-size: 36px;
  font-weight: 400;
}
.hero .wrap p {
  font-size: 20px;
  line-height: 1.4;
}
.hero input[type=button] {
  margin-right: 15px;
  padding: 7px 15px;
  background-color: #666;
  border: 0;
  border-radius: 100px;
  font-family: inherit;
  font-size: inherit;
  color: #FFF;
  cursor: pointer;
  outline: none;
}
.hero input[type=button]:hover {
  background-color: #444;
}
.hero input[type=button].highlight {
  background-color: #ef5350;
}
.hero input[type=button].highlight:hover {
  background-color: #d32f2f;
}
options {
  display: inline-block;
  padding: 3px 7px;
  // background-color: #29b6f6;
  // background-color: #000;
  // color: #FFF;
  border-bottom: 2px solid #000;
  // background-color: #eceff1;
  // border: 2px solid #000;
}
options option {
  display: none;
}
options option:first-child {
  display: inline;
}
options option {
#canvas {
  width: 100vw;
  height: 100vh;
  // background-color: #000;
}
    </style>
  </head>
  <body>
    <div class=hero>
      <div class=wrap>
        <h1>
          <options>
            <option>Upload</option>
            <option>Download</option>
            <option>Jack in to</option>
          </options> the shared<br/>
          <options>
            <option>3D</option>
            <option>VR</option>
            <option>AR</option>
          </options> web<br/>
        </h1>
        <p>
          A multiplayer WebXR grid in your browser.<br/>
          Drop in any 3D site. Support creators on the blockchain.
        </p>
        <div class=buttons>
          <input type=button class=highlight value="Request Access"> <input type=button value="Learn more">
        </div>
      </div>
    </div>
    <canvas id=canvas></canvas>
    <script src="https://kit.fontawesome.com/0735724151.js"></script>
    <script src="three.js"></script>
    <script src="OrbitControls.js"></script>
    <script src="TransformControls.js"></script>
    <script src="BufferGeometryUtils.js"></script>
    <script src="GLTFLoader.js"></script>
    <script src="LegacyGLTFLoader.js"></script>
    <script src="EffectComposer.js"></script>
    <script src="CopyShader.js"></script>
    <script src="SSAOShader.js"></script>
    <script src="SimplexNoise.js"></script>
    <script src="ShaderPass.js"></script>
    <script src="SSAOPass.js"></script>
    <script src="skin.js"></script>
    <script src="vox.js"></script>
    <script>
console.log('parsing 1');
const canvas = document.getElementById('canvas');
const renderer = new THREE.WebGLRenderer({
  canvas,
  antialias: true,
  alpha: true,
});
renderer.setSize(window.innerWidth, window.innerHeight);
renderer.setPixelRatio(window.devicePixelRatio);
renderer.shadowMap.enabled = true;
renderer.shadowMap.type = THREE.PCFSoftShadowMap;

const scene = new THREE.Scene();
const camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 1, 500);
camera.position.set(-119.32842134594114, 57.23872267212144, -22.968761332644423);
// const camera = new THREE.OrthographicCamera();
// camera.position.set(-119.32842134594114, 57.23872267212144, -22.968761332644423);
// camera.quaternion.set(-0.1248035130924295, -0.6969980023064662, -0.12517204166320742, 0.6949459172384909);
camera.lookAt(new THREE.Vector3(0, 0, -25));
// camera.lookAt(new THREE.Vector3());
// camera.updateMatrixWorld();
// camera.rotation.order = 'YXZ';
// camera.rotation.y = Math.PI;

const composer = new THREE.EffectComposer(renderer);
composer.setSize(window.innerWidth, window.innerHeight);
const ssaoPass = new THREE.SSAOPass(scene, camera, window.innerWidth, window.innerHeight);
ssaoPass.kernelRadius = 1;
ssaoPass.kernelSize = 256;
ssaoPass.minDistance = 0.001;
ssaoPass.maxDistance = 1;

composer.addPass(ssaoPass);

const ambientLight = new THREE.AmbientLight(0xFFFFFF, 0.5);
scene.add(ambientLight);

const directionalLight = new THREE.DirectionalLight(0x808080, 1);
directionalLight.position.set(100, 150, 100);
directionalLight.shadow.mapSize.width = 1024;
directionalLight.shadow.mapSize.height = 1024;
directionalLight.shadow.camera = new THREE.PerspectiveCamera(90);
/* directionalLight.shadow.camera.left = -100; 
directionalLight.shadow.camera.right = 100;
directionalLight.shadow.camera.top = 100;
directionalLight.shadow.camera.bottom = -100;
directionalLight.shadow.camera.near = 100;
directionalLight.shadow.camera.far = 500; */
directionalLight.castShadow = true;
scene.add(directionalLight);

// const cameraHelper = new THREE.CameraHelper(directionalLight.shadow.camera);
// scene.add(cameraHelper);

function animate() {
  composer.render();
  // renderer.render(scene, camera);
}
renderer.setAnimationLoop(animate);

/* const orbitControls = new THREE.OrbitControls(camera, renderer.domElement);
orbitControls.target.set(0, 0, -25);
orbitControls.screenSpacePanning = true; */

const floorMesh = (() => {
  const geometry = new THREE.PlaneBufferGeometry(2000, 2000)
    .applyMatrix(new THREE.Matrix4().makeRotationFromQuaternion(new THREE.Quaternion().setFromUnitVectors(new THREE.Vector3(0, -1, 0), new THREE.Vector3(0, 0, 1))))
    // .applyMatrix(new THREE.Matrix4().makeTranslation(-0.5, 0, -0.5));
  const floorVsh = `
    uniform float uAnimation;
    // attribute float scene;
    varying vec3 vPosition;
    // varying float vScene;
    varying float vDepth;
    void main() {
      float radius = sqrt(position.x*position.x + position.z*position.z);
      // vec3 p = vec3(position.x, position.y - (1.0 - uAnimation * radius), position.z);
      vec3 p = vec3(position.x, position.y - (1.0 - uAnimation) * radius, position.z);
      gl_Position = projectionMatrix * modelViewMatrix * vec4(p, 1.);
      vPosition = position;
      // vScene = scene;
      vDepth = gl_Position.z / 1000.0;
    }
  `;
  const floorFsh = `
    uniform float uAnimation;
    // uniform sampler2D uTex;
    varying vec3 vPosition;
    // varying float vScene;
    varying float vDepth;
    void main() {
      vec3 c;
      float a;
      c = vec3(0.8 + vDepth);
      vec3 f = fract(vPosition / 64.0);
      if (f.x <= 0.01 || f.x >= 0.99 || f.z <= 0.01 || f.z >= 0.99) {
        discard;
      } else {
        a = uAnimation*0.5;
      }
      gl_FragColor = vec4(c, a);
    }
  `;
  const material = new THREE.ShaderMaterial({
    uniforms: {
      /* uTex: {
        type: 't',
        value: new THREE.Texture(),
      }, */
      uAnimation: {
        type: 'f',
        value: 1,
      },
    },
    vertexShader: floorVsh,
    fragmentShader: floorFsh,
    transparent: true,
  });
  const mesh = new THREE.Mesh(geometry, material);
  mesh.frustumCulled = false;
  return mesh;
})();
scene.add(floorMesh);

console.log('parsing 2');
const parser = new vox.Parser();
console.log('parsing 3');
parser.parse('webaverse.vox').then(voxelData => {
  console.log('got data', voxelData);

  // voxelData.voxels; // voxel position and color data
  // voxelData.size; // model size
  // voxelData.palette; // palette data

  const param = {
    voxelSize: 1,
  };
  const builder = new vox.MeshBuilder(voxelData, param);
  const mesh = builder.createMesh();
  mesh.position.y = -2;
  /* mesh.position.z = -50;
  mesh.rotation.order = 'YXZ';
  mesh.rotation.y = Math.PI; */
  mesh.castShadow = true;
  mesh.receiveShadow = true;
  scene.add(mesh);
});
console.log('parsing 4');
    </script>
  </body>
</html>
